name: Milestone Reminder

on:
  schedule:
    # Runs every day at 9 AM UTC
    - cron: "0 9 * * *"
  workflow_dispatch: # allow manual trigger

permissions:
  issues: write   # âœ… needed to comment on issues
  contents: read  # safe default

jobs:
  milestone-reminder:
    runs-on: ubuntu-latest

    steps:
      - name: Check milestones and send reminders
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            // Get both open and closed milestones
            const { data: milestones } = await github.paginate(github.rest.issues.listMilestones, {
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: "all"
            });

            const today = new Date();
            today.setUTCHours(0,0,0,0); // normalize to start of day

            const upcoming = milestones.filter(m => {
              if (!m.due_on) return false;
              const dueDate = new Date(m.due_on);
              dueDate.setUTCHours(0,0,0,0);
              const diffDays = Math.ceil((dueDate - today) / (1000 * 60 * 60 * 24));

              // include due today (diffDays === 0), upcoming (<=3), and also closed milestones due today
              return diffDays <= 3 && diffDays >= 0;
            });

            if (upcoming.length === 0) {
              console.log("âœ… No milestones due soon.");
              return;
            }

            for (const m of upcoming) {
              const dueDate = new Date(m.due_on).toISOString().split("T")[0];
              const description = m.description ? m.description : "No description provided.";
              const assignee = m.creator ? `ğŸ‘¤ Assigned to: @${m.creator.login}` : "ğŸ‘¤ No assignee.";
              const state = m.state === "closed" ? "âœ… (Closed)" : "ğŸŸ¢ (Open)";

              const message = `âš ï¸ Reminder: Milestone **${m.title}** is due on ${dueDate} ${state}\n\nğŸ“Œ **Description:** ${description}\n\nğŸ”¢ **Open Issues:** ${m.open_issues}\n${assignee}`;

              // Post a comment to a tracking issue (update the issue_number!)
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: 1, // ğŸ‘ˆ change this to your actual tracking issue
                body: message
              });

              console.log("Posted reminder for milestone:", m.title);
            }
