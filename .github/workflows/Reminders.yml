name: Milestone Reminder

on:
  schedule:
    # Runs every day at 9 AM UTC
    - cron: "0 9 * * *"
  workflow_dispatch: # allow manual trigger

permissions:
  issues: write   # ✅ needed to comment on issues
  contents: read  # safe default

jobs:
  milestone-reminder:
    runs-on: ubuntu-latest

    steps:
      - name: Check milestones and send reminders
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            // Get both open and closed milestones
            const { data: milestones } = await github.paginate(github.rest.issues.listMilestones, {
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: "all"
            });

            const today = new Date();
            today.setUTCHours(0,0,0,0); // normalize to start of day

            const upcoming = milestones.filter(m => {
              if (!m.due_on) return false;
              const dueDate = new Date(m.due_on);
              dueDate.setUTCHours(0,0,0,0);
              const diffDays = Math.ceil((dueDate - today) / (1000 * 60 * 60 * 24));

              // include milestones due today or within next 3 days
              return diffDays <= 3 && diffDays >= 0;
            });

            if (upcoming.length === 0) {
              console.log("✅ No milestones due soon.");
              return;
            }

            // Build one combined reminder message
            let combinedMessage = "## ⏰ Milestone Reminder\n\n";
            for (const m of upcoming) {
              const dueDate = new Date(m.due_on).toISOString().split("T")[0];
              const description = m.description ? m.description : "No description provided.";
              const assignee = m.creator ? `👤 Assigned to: @${m.creator.login}` : "👤 No assignee.";
              const state = m.state === "closed" ? "✅ (Closed)" : "🟢 (Open)";

              combinedMessage += `### 🔹 ${m.title} — Due on ${dueDate} ${state}\n`;
              combinedMessage += `📌 **Description:** ${description}\n\n`;
              combinedMessage += `🔢 **Open Issues:** ${m.open_issues}\n`;
              combinedMessage += `${assignee}\n\n---\n\n`;
            }

            // Post one comment with all reminders
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: 1, // 👈 change to your tracking issue
              body: combinedMessage
            });

            console.log("✅ Posted combined milestone reminder.");
