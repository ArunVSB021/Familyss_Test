name: Milestone Reminder

on:
  schedule:
    - cron: "0 9 * * *" # Runs every day at 9 AM UTC
  workflow_dispatch: # allow manual trigger

permissions:
  issues: read
  contents: read

jobs:
  milestone-reminder:
    runs-on: ubuntu-latest

    steps:
      - name: Collect milestone reminders
        id: collect
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const { data: milestones } = await github.paginate(
              github.rest.issues.listMilestones,
              {
                owner: context.repo.owner,
                repo: context.repo.repo,
                state: "all"
              }
            );

            const today = new Date();
            today.setUTCHours(0,0,0,0);

            const upcoming = milestones.filter(m => {
              if (!m.due_on) return false;
              const dueDate = new Date(m.due_on);
              dueDate.setUTCHours(0,0,0,0);
              const diffDays = Math.ceil((dueDate - today) / (1000 * 60 * 60 * 24));
              return diffDays <= 3 && diffDays >= 0; // Due today or within next 3 days
            });

            if (upcoming.length === 0) {
              core.setOutput("body", "âœ… No milestones due today or soon.");
              return;
            }

            let body = `ðŸ“¢ **Milestone Reminder Report**\n\n`;
            for (const m of upcoming) {
              const dueDate = new Date(m.due_on).toISOString().split("T")[0];
              const description = m.description || "No description provided.";
              const assignee = m.creator ? `ðŸ‘¤ Assigned to: @${m.creator.login}` : "ðŸ‘¤ No assignee.";
              const state = m.state === "closed" ? "âœ… (Closed)" : "ðŸŸ¢ (Open)";
              body += `---\n### ${m.title} ${state}\n- ðŸ“… Due: ${dueDate}\n- ðŸ“Œ Description: ${description}\n- ðŸ”¢ Open Issues: ${m.open_issues}\n- ${assignee}\n\n`;
            }

            core.setOutput("body", body);

      - name: Send Email Report
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          username: ${{ secrets.SMTP_USERNAME }}
          password: ${{ secrets.SMTP_PASSWORD }}
          subject: "ðŸ“¢ GitHub Milestone Reminder Report"
          to: team@example.com
          from: "github-actions@example.com"
          content_type: text/markdown
          body: ${{ steps.collect.outputs.body }}
